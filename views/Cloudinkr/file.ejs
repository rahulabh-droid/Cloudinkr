<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CloudInkr Files</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      padding: 20px;
    }

    #bgVideo {
      position: fixed;
      top: 0;
      left: 0;
      min-width: 100%;
      min-height: 100%;
      z-index: -1;
      object-fit: cover;
      filter: brightness(0.6);
    }

    .file-card {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      overflow: hidden;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      padding: 1rem;
    }

    .file-card .card-body,
    .file-card .text-center {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 1rem;
      text-align: center;
    }

    .file-card img {
      width: 100%;
      height: 150px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .file-checkbox {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 2;
      transform: scale(1.2);
    }

    .card-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Hide the original delete and duplicate buttons */
    .d-flex.justify-content-between,
    a[href="/files/duplicates"] {
      display: none;
    }

    #toggleMenu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      left: auto;
      margin-top: 8px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      min-width: 160px;
      z-index: 1051;
    }

    span {
      color: blanchedalmond
    }
  </style>
</head>

<body>
  <video autoplay muted loop id="bgVideo">
    <source src="/video/video2.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>

  <div id="toggleMenuWrapper" style="position: fixed; top: 20px; right: 20px; z-index: 1050;">
    <button id="toggleMenuBtn" class="btn btn-secondary btn-sm" title="Options"
      style="padding: 6px 10px; font-weight: bold;">
      &#x22EE; </button>

    <div id="toggleMenu"
      style="display: none; margin-top: 8px; background: rgba(255, 255, 255, 0.9); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 160px;">
      <button id="deleteSelectedTop" class="btn btn-danger btn-sm w-100 mb-1">üóëÔ∏è Delete Selected</button>
      <button id="findDuplicatesBtn" class="btn btn-primary btn-sm w-100">Find Duplicate Images</button>
    </div>
  </div>

  <div class="container">
    <span>
      <h1 class="mb-4 text-center">CloudInkr Uploads</h1>
    </span>

    <% if (files.length===0) { %>
      <p class="text-center fs-4">No files found.</p>
    <% } else { %>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <input type="checkbox" id="selectAll" class="form-check-input me-2" />
          <label for="selectAll" class="form-check-label">Select All</label>
          <a href="/files/duplicates">
            <button style="margin: 10px;">Find Duplicate Images</button>
          </a>

          <div class="row row-cols-1 row-cols-md-3 g-4">
            <% files.forEach(file=> { %>
              <div class="col">

                <% if (['png', 'jpg' , 'jpeg' , 'gif' , 'webp' ].includes(file.format)) { %>
                  <div class="card file-card shadow-sm h-100">
                    <input type="checkbox" class="form-check-input file-checkbox" value="<%= file.public_id %>" data-filename="<%= file.filename %>" data-resource-type="<%= file.resource_type %>" />
                    <a href="<%= file.secure_url %>" target="_blank">
                      <img src="<%= file.secure_url %>" alt="<%= file.filename %>" class="card-img-top" />
                    </a>
                    <div class="card-body">
                      <h5 class="card-title" title="<%= file.filename %>"><%= file.filename %></h5>
                      <a href="<%= file.secure_url %>" target="_blank" class="btn btn-primary btn-sm">View</a>
                      <a href="/download?public_id=<%= encodeURIComponent(file.public_id) %>&resource_type=<%= file.resource_type %>&format=<%= file.format %>" class="btn btn-outline-secondary btn-sm ms-2">Download</a>
                    </div>
                  </div>

                <% } else if (['mp4', 'mov', 'webm', 'avi'].includes(file.format)) { %>
                  <div class="card file-card shadow-sm h-100">
                    <input type="checkbox" class="form-check-input file-checkbox" value="<%= file.public_id %>" data-filename="<%= file.filename %>" data-resource-type="<%= file.resource_type %>" />
                    <% const videoThumbnailUrl = file.secure_url.replace(/\.\w+$/, '.jpg'); %>
                    <a href="<%= file.secure_url %>" target="_blank">
                      <img src="<%= videoThumbnailUrl %>" alt="<%= file.filename %>" class="card-img-top" />
                    </a>
                    <div class="card-body">
                      <h5 class="card-title" title="<%= file.filename %>"><%= file.filename %></h5>
                      <a href="<%= file.secure_url %>" target="_blank" class="btn btn-primary btn-sm">View</a>
                      <a href="/download?public_id=<%= encodeURIComponent(file.public_id) %>&resource_type=<%= file.resource_type %>&format=<%= file.format %>" class="btn btn-outline-secondary btn-sm ms-2">Download</a>
                    </div>
                  </div>

                <% } else if (file.format === 'pdf') { %>
                  <div class="card file-card shadow-sm h-100">
                    <input type="checkbox" class="form-check-input file-checkbox" value="<%= file.public_id %>" data-filename="<%= file.filename %>" data-resource-type="<%= file.resource_type %>" />
                    <% const pdfThumbnailUrl = file.secure_url.replace(/\.\w+$/, '.jpg'); %>
                    <img src="<%= pdfThumbnailUrl %>" alt="<%= file.filename %>" class="card-img-top" />
                    <div class="card-body">
                      <h5 class="card-title" title="<%= file.filename %>"><%= file.filename %></h5>
                      </div>
                  </div>
                
                <% } else { %>
                  <div class="card file-card shadow-sm p-3 h-100 text-center">
                    <input type="checkbox" class="form-check-input file-checkbox" value="<%= file.public_id %>" data-filename="<%= file.filename %>" />
                    <div class="mb-3" style="font-size: 3rem;">üìÅ</div>
                    <h6 class="text-truncate" title="<%= file.filename %>"><%= file.filename %></h6>
                    <div class="mt-auto">
                      <a href="<%= file.secure_url %>" target="_blank" class="btn btn-primary btn-sm">Open</a>
                      <a href="/download?public_id=<%= encodeURIComponent(file.public_id) %>&resource_type=raw&format=<%= file.format %>" class="btn btn-outline-secondary btn-sm ms-2">Download</a>
                    </div>
                  </div>
                <% } %>
              </div>
            <% }); %>
          </div>
        </div>
      </div>
    <% } %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const selectAll = document.getElementById("selectAll");
      const deleteBtn = document.getElementById("deleteSelected");

      selectAll?.addEventListener("change", () => {
        document.querySelectorAll(".file-checkbox").forEach(cb => {
          cb.checked = selectAll.checked;
        });
      });

      deleteBtn?.addEventListener("click", async () => {
        const selected = Array.from(document.querySelectorAll(".file-checkbox:checked"));
        if (selected.length === 0) {
          return alert("Please select at least one file to delete.");
        }

        const confirmed = confirm(`Are you sure you want to delete ${selected.length} file(s)?`);
        if (!confirmed) return;

        const files = selected.map(cb => ({
          public_id: cb.value,
          resource_type: cb.dataset.resourceType, // Adjust here as needed
        }));

        try {
          const res = await fetch('/api/delete-files', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ files }),
          });

          const data = await res.json();

          if (data.success) {
            alert("Files deleted successfully.");
            selected.forEach(cb => cb.closest(".col").remove());
          } else {
            alert("Error deleting files.");
          }
        } catch (err) {
          console.error("Error:", err);
          alert("Server error while deleting files.");
        }
      });

      // Toggle menu button code
      const toggleBtn = document.getElementById('toggleMenuBtn');
      const toggleMenu = document.getElementById('toggleMenu');
      const deleteSelectedTop = document.getElementById('deleteSelectedTop');
      const findDuplicatesBtn = document.getElementById('findDuplicatesBtn');

      toggleBtn.addEventListener('click', () => {
        if (toggleMenu.style.display === 'none' || toggleMenu.style.display === '') {
          toggleMenu.style.display = 'block';
        } else {
          toggleMenu.style.display = 'none';
        }
      });

      // Delete selected files via top toggle menu
      deleteSelectedTop.addEventListener('click', () => {
        const selected = Array.from(document.querySelectorAll(".file-checkbox:checked"));
        if (selected.length === 0) {
          return alert("Please select at least one file to delete.");
        }

        const confirmed = confirm(`Are you sure you want to delete ${selected.length} file(s)?`);
        if (!confirmed) return;

        const files = selected.map(cb => ({
          public_id: cb.value,
          resource_type: cb.dataset.resourceType,
        }));

        fetch('/api/delete-files', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ files }),
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert("Files deleted successfully.");
              selected.forEach(cb => cb.closest(".col").remove());
            } else {
              alert("Error deleting files.");
            }
          })
          .catch(err => {
            console.error("Error:", err);
            alert("Server error while deleting files.");
          });
      });

      // Navigate to duplicate images page
      findDuplicatesBtn.addEventListener('click', () => {
        window.location.href = '/files/duplicates';
      });
    </script>
</body>
</html>